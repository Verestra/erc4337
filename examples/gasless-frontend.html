<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ERC-4337 Gasless Demo</title>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 900px;
            margin: 50px auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        h1 {
            color: #333;
            margin-bottom: 10px;
        }
        .subtitle {
            color: #666;
            margin-bottom: 20px;
        }
        .gasless-badge {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            display: inline-block;
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 20px;
        }
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 14px 28px;
            font-size: 16px;
            border-radius: 8px;
            cursor: pointer;
            margin: 5px;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }
        button:disabled {
            background: #cccccc;
            cursor: not-allowed;
            transform: none;
        }
        .info {
            background: #e3f2fd;
            padding: 15px;
            margin: 15px 0;
            border-radius: 8px;
            border-left: 4px solid #2196F3;
        }
        .success {
            background: #e8f5e9;
            padding: 15px;
            margin: 15px 0;
            border-radius: 8px;
            border-left: 4px solid #4CAF50;
        }
        .error {
            background: #ffebee;
            padding: 15px;
            margin: 15px 0;
            border-radius: 8px;
            border-left: 4px solid #f44336;
        }
        .warning {
            background: #fff3e0;
            padding: 15px;
            margin: 15px 0;
            border-radius: 8px;
            border-left: 4px solid #ff9800;
        }
        input {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        input:focus {
            outline: none;
            border-color: #667eea;
        }
        .address {
            font-family: monospace;
            background: #f5f5f5;
            padding: 10px;
            border-radius: 5px;
            word-break: break-all;
            font-size: 13px;
        }
        .gas-info {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            text-align: center;
            font-weight: bold;
        }
        .section {
            margin: 30px 0;
            padding: 20px;
            background: #fafafa;
            border-radius: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>‚ö° ERC-4337 Gasless Demo</h1>
        <p class="subtitle">Completely gasless transactions - Backend pays all fees!</p>
        <span class="gasless-badge">üíé ZERO GAS FEES FOR USERS</span>

        <div class="info">
            <strong>üéØ How it works:</strong>
            <ul style="margin: 10px 0;">
                <li><strong>Account Creation:</strong> Backend pays gas ‚úÖ</li>
                <li><strong>Send ETH:</strong> Backend pays gas ‚úÖ</li>
                <li><strong>Your MetaMask:</strong> Only for signing (no gas!) ‚úÖ</li>
            </ul>
            <strong>‚öôÔ∏è Backend API:</strong> http://localhost:3131
        </div>

        <!-- Backend Status -->
        <div class="section">
            <h2>üîå Backend Status</h2>
            <button onclick="checkBackend()">Check Backend</button>
            <div id="backendStatus"></div>
        </div>

        <!-- Connect Wallet -->
        <div class="section">
            <h2>1. Connect Wallet</h2>
            <button id="connectBtn" onclick="connectWallet()">Connect MetaMask</button>
            <div id="walletInfo"></div>
        </div>

        <!-- Create Smart Account -->
        <div id="createSection" class="section" style="display: none;">
            <h2>2. Create Smart Account (Gasless)</h2>
            <p>Salt (for deterministic address generation):</p>
            <input type="number" id="saltInput" value="0" placeholder="Salt (0, 1, 2, ...)">
            <br>
            <button onclick="getSmartAccountAddress()">üîç Preview Address</button>
            <button onclick="createSmartAccountGasless()">‚ú® Create Account (Backend Pays Gas)</button>
            <div id="accountInfo"></div>
        </div>

        <!-- Interact with Account -->
        <div id="interactSection" class="section" style="display: none;">
            <h2>3. Use Your Smart Account (Gasless)</h2>
            <div class="success" id="accountDetails"></div>

            <h3>Send ETH (Gasless Transaction)</h3>
            <input type="text" id="recipientInput" placeholder="Recipient address (0x...)">
            <input type="text" id="amountInput" placeholder="Amount in ETH (e.g., 0.001)">
            <button onclick="sendEtherGasless()">üí∏ Send ETH (Backend Pays Gas)</button>

            <div id="txResult"></div>
        </div>

        <div class="gas-info" style="margin-top: 30px;">
            üí∞ Total Gas You Paid: <span id="totalGasPaid">0 ETH</span>
        </div>
    </div>

    <script>
        // Check if ethers is loaded
        if (typeof ethers === 'undefined') {
            document.body.innerHTML = '<div style="padding: 50px; text-align: center;"><h1>‚ùå Error Loading ethers.js</h1><p>Please check your internet connection and refresh the page.</p></div>';
            throw new Error('ethers.js failed to load');
        }

        console.log('‚úÖ ethers.js loaded successfully:', ethers.version);

        // Backend API URL
        const BACKEND_URL = 'http://localhost:3131';
        const FACTORY_ADDRESS = '0xbCa99c484Ca08B7c5FDaC58e2505a08595955B8F';
        const RPC_URL = 'https://rpc.sepolia-api.lisk.com';
        const CHAIN_ID = 4202;

        let provider, signer, userAddress;
        let totalGasPaid = 0; // Track gas - should stay 0!

        const FACTORY_ABI = [
            'function getAddress(address owner, uint256 salt) view returns (address)'
        ];

        // Check backend status
        async function checkBackend() {
            try {
                document.getElementById('backendStatus').innerHTML = `
                    <div class="info">‚è≥ Checking backend...</div>
                `;

                const response = await fetch(`${BACKEND_URL}/api/backend/info`);
                const data = await response.json();

                if (data.success) {
                    document.getElementById('backendStatus').innerHTML = `
                        <div class="success">
                            <strong>‚úÖ Backend Connected!</strong><br>
                            Wallet: <span class="address">${data.backend.address}</span><br>
                            Balance: ${data.backend.balance} ETH<br>
                            Network: ${data.backend.network}<br>
                            <small>This wallet will pay gas for all transactions</small>
                        </div>
                    `;
                } else {
                    throw new Error('Backend response failed');
                }
            } catch (error) {
                document.getElementById('backendStatus').innerHTML = `
                    <div class="error">
                        <strong>‚ùå Backend Not Available</strong><br>
                        ${error.message}<br><br>
                        <strong>Start the backend:</strong><br>
                        <code style="display: block; background: #f5f5f5; padding: 10px; margin: 10px 0;">
                        cd examples/backend<br>
                        npm install<br>
                        npm start
                        </code>
                    </div>
                `;
            }
        }

        async function connectWallet() {
            try {
                if (typeof window.ethereum === 'undefined') {
                    alert('Please install MetaMask!');
                    return;
                }

                await window.ethereum.request({ method: 'eth_requestAccounts' });
                provider = new ethers.providers.Web3Provider(window.ethereum);
                signer = provider.getSigner();
                userAddress = await signer.getAddress();

                // Check if on correct network
                const network = await provider.getNetwork();
                if (network.chainId !== CHAIN_ID) {
                    try {
                        await window.ethereum.request({
                            method: 'wallet_switchEthereumChain',
                            params: [{ chainId: '0x' + CHAIN_ID.toString(16) }],
                        });
                    } catch (switchError) {
                        if (switchError.code === 4902) {
                            await window.ethereum.request({
                                method: 'wallet_addEthereumChain',
                                params: [{
                                    chainId: '0x' + CHAIN_ID.toString(16),
                                    chainName: 'Lisk Sepolia',
                                    nativeCurrency: {
                                        name: 'Sepolia Ether',
                                        symbol: 'ETH',
                                        decimals: 18
                                    },
                                    rpcUrls: [RPC_URL],
                                    blockExplorerUrls: ['https://sepolia-blockscout.lisk.com']
                                }]
                            });
                        }
                    }
                }

                const balance = await provider.getBalance(userAddress);

                document.getElementById('walletInfo').innerHTML = `
                    <div class="success">
                        <strong>‚úÖ Connected!</strong><br>
                        Address: <span class="address">${userAddress}</span><br>
                        Balance: ${ethers.utils.formatEther(balance)} ETH<br>
                        <small>üéØ You will NOT pay any gas fees!</small>
                    </div>
                `;

                document.getElementById('createSection').style.display = 'block';
                document.getElementById('connectBtn').disabled = true;

                // Auto-check backend
                checkBackend();
            } catch (error) {
                document.getElementById('walletInfo').innerHTML = `
                    <div class="error">‚ùå ${error.message}</div>
                `;
            }
        }

        async function getSmartAccountAddress() {
            try {
                const salt = document.getElementById('saltInput').value;
                const readProvider = new ethers.providers.JsonRpcProvider(RPC_URL);
                const factory = new ethers.Contract(FACTORY_ADDRESS, FACTORY_ABI, readProvider);
                const predictedAddress = await factory.getAddress(userAddress, salt);

                // Check if already deployed via backend API
                const response = await fetch(`${BACKEND_URL}/api/account/${userAddress}/${salt}`);
                const data = await response.json();

                document.getElementById('accountInfo').innerHTML = `
                    <div class="info">
                        <strong>üìç Smart Account Address:</strong><br>
                        <span class="address">${predictedAddress}</span><br><br>
                        Status: ${data.isDeployed ? '‚úÖ Already deployed' : '‚è≥ Not deployed yet'}<br>
                        ${data.isDeployed ? `
                            Balance: ${data.accountInfo.balance} ETH<br>
                            <a href="${data.explorerUrl}" target="_blank">View on Explorer</a>
                        ` : ''}
                    </div>
                `;

                if (data.isDeployed) {
                    loadAccountDetails(predictedAddress);
                }
            } catch (error) {
                document.getElementById('accountInfo').innerHTML = `
                    <div class="error">‚ùå ${error.message}</div>
                `;
            }
        }

        async function createSmartAccountGasless() {
            try {
                const salt = document.getElementById('saltInput').value;

                document.getElementById('accountInfo').innerHTML = `
                    <div class="info">‚è≥ Creating smart account (backend paying gas)...</div>
                `;

                // Call backend API to create account
                const response = await fetch(`${BACKEND_URL}/api/account/create`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        owner: userAddress,
                        salt: parseInt(salt)
                    })
                });

                const data = await response.json();

                if (data.success) {
                    document.getElementById('accountInfo').innerHTML = `
                        <div class="success">
                            <strong>‚úÖ Smart Account ${data.alreadyExists ? 'Already Exists' : 'Created'}!</strong><br>
                            Address: <span class="address">${data.accountAddress}</span><br>
                            ${data.transactionHash ? `Transaction: <a href="${data.txUrl}" target="_blank">${data.transactionHash.substring(0, 10)}...</a><br>` : ''}
                            ${data.gasUsed ? `Gas Used: ${data.gasUsed} (Paid by backend)<br>` : ''}
                            <a href="${data.explorerUrl}" target="_blank">View on Explorer</a><br><br>
                            <div class="gas-info">
                                üéâ You paid: <strong>0 ETH</strong> - Backend paid all gas!
                            </div>
                        </div>
                    `;

                    loadAccountDetails(data.accountAddress);
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                document.getElementById('accountInfo').innerHTML = `
                    <div class="error">‚ùå ${error.message}</div>
                `;
            }
        }

        async function loadAccountDetails(accountAddress) {
            try {
                // Get account details from backend
                const response = await fetch(`${BACKEND_URL}/api/account/${accountAddress}`);
                const data = await response.json();

                if (data.success) {
                    document.getElementById('accountDetails').innerHTML = `
                        <strong>üìä Account Details:</strong><br>
                        Address: <span class="address">${data.account.address}</span><br>
                        Owner: <span class="address">${data.account.owner}</span><br>
                        Balance: ${data.account.balance} ETH<br>
                        Nonce: ${data.account.nonce}<br>
                        <a href="${data.explorerUrl}" target="_blank">View on Explorer</a>
                    `;

                    document.getElementById('interactSection').style.display = 'block';
                    window.smartAccountAddress = accountAddress;
                }
            } catch (error) {
                console.error('Error loading account details:', error);
            }
        }

        async function sendEtherGasless() {
            try {
                const recipient = document.getElementById('recipientInput').value;
                const amount = document.getElementById('amountInput').value;

                if (!ethers.utils.isAddress(recipient)) {
                    alert('Invalid recipient address');
                    return;
                }

                if (!amount || parseFloat(amount) <= 0) {
                    alert('Invalid amount');
                    return;
                }

                document.getElementById('txResult').innerHTML = `
                    <div class="info">‚è≥ Sending transaction (backend paying gas)...</div>
                `;

                // Call backend API to execute transaction
                const response = await fetch(`${BACKEND_URL}/api/transaction/execute`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        accountAddress: window.smartAccountAddress,
                        recipient: recipient,
                        amount: amount
                    })
                });

                const data = await response.json();

                if (data.success) {
                    document.getElementById('txResult').innerHTML = `
                        <div class="success">
                            <strong>‚úÖ Transaction Successful!</strong><br>
                            Sent ${data.amount} ETH to <span class="address">${data.to}</span><br>
                            Transaction: <a href="${data.txUrl}" target="_blank">${data.transactionHash.substring(0, 16)}...</a><br>
                            Gas Used: ${data.gasUsed} (Paid by backend)<br><br>
                            <div class="gas-info">
                                üéâ You paid: <strong>0 ETH</strong> - Backend paid all gas!
                            </div>
                        </div>
                    `;

                    // Refresh balance
                    loadAccountDetails(window.smartAccountAddress);

                    // Update total gas display
                    document.getElementById('totalGasPaid').textContent = totalGasPaid + ' ETH';
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                document.getElementById('txResult').innerHTML = `
                    <div class="error">‚ùå ${error.message}</div>
                `;
            }
        }

        // Auto-check backend on load
        window.addEventListener('load', () => {
            setTimeout(checkBackend, 500);
        });
    </script>
</body>
</html>
