<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ERC-4337 Smart Account Demo</title>
    <!-- Using unpkg CDN for better reliability -->
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 16px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #45a049;
        }
        button:disabled {
            background: #cccccc;
            cursor: not-allowed;
        }
        .info {
            background: #e3f2fd;
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
            border-left: 4px solid #2196F3;
        }
        .success {
            background: #e8f5e9;
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
            border-left: 4px solid #4CAF50;
        }
        .error {
            background: #ffebee;
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
            border-left: 4px solid #f44336;
        }
        input {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        .address {
            font-family: monospace;
            background: #f5f5f5;
            padding: 10px;
            border-radius: 5px;
            word-break: break-all;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÄ ERC-4337 Smart Account Demo</h1>
        <p>Interact with your deployed smart account contracts on Lisk Sepolia</p>

        <div class="info">
            <strong>üìù Note:</strong> This demo uses MetaMask. Make sure you're connected to Lisk Sepolia testnet.
            <br><br>
            <strong>Network Details:</strong>
            <ul>
                <li>Chain ID: 4202</li>
                <li>RPC URL: https://rpc.sepolia-api.lisk.com</li>
            </ul>
        </div>

        <!-- Connect Wallet -->
        <div id="walletSection">
            <h2>1. Connect Wallet</h2>
            <button id="connectBtn" onclick="connectWallet()">Connect MetaMask</button>
            <div id="walletInfo"></div>
        </div>

        <!-- Create Smart Account -->
        <div id="createSection" style="display: none;">
            <h2>2. Create Smart Account</h2>
            <p>Salt (for deterministic address generation):</p>
            <input type="number" id="saltInput" value="0" placeholder="Salt (0, 1, 2, ...)">
            <br>
            <button onclick="getSmartAccountAddress()">üîç Preview Address</button>
            <button onclick="createSmartAccount()">‚ú® Create Account</button>
            <div id="accountInfo"></div>
        </div>

        <!-- Interact with Account -->
        <div id="interactSection" style="display: none;">
            <h2>3. Use Your Smart Account</h2>
            <div class="success" id="accountDetails"></div>

            <h3>Send ETH</h3>
            <input type="text" id="recipientInput" placeholder="Recipient address (0x...)">
            <input type="text" id="amountInput" placeholder="Amount in ETH (e.g., 0.001)">
            <button onclick="sendEther()">üí∏ Send ETH</button>

            <div id="txResult"></div>
        </div>
    </div>

    <script>
        // Check if ethers is loaded
        if (typeof ethers === 'undefined') {
            document.body.innerHTML = '<div style="padding: 50px; text-align: center;"><h1>‚ùå Error Loading ethers.js</h1><p>Please check your internet connection and refresh the page.</p></div>';
            throw new Error('ethers.js failed to load');
        }

        console.log('‚úÖ ethers.js loaded successfully:', ethers.version);

        // Deployed contract addresses on Lisk Sepolia
        const FACTORY_ADDRESS = '0xbCa99c484Ca08B7c5FDaC58e2505a08595955B8F';
        const RPC_URL = 'https://rpc.sepolia-api.lisk.com';
        const CHAIN_ID = 4202;

        let provider, signer, userAddress;

        const FACTORY_ABI = [
            'function createAccount(address owner, uint256 salt) returns (address)',
            'function getAddress(address owner, uint256 salt) view returns (address)',
            'function accountImplementation() view returns (address)'
        ];

        const ACCOUNT_ABI = [
            'function execute(address dest, uint256 value, bytes calldata func)',
            'function executeBatch(address[] calldata dest, uint256[] calldata value, bytes[] calldata func)',
            'function owner() view returns (address)',
            'function entryPoint() view returns (address)',
            'function getNonce() view returns (uint256)'
        ];

        async function connectWallet() {
            try {
                if (typeof window.ethereum === 'undefined') {
                    alert('Please install MetaMask!');
                    return;
                }

                // Request account access
                await window.ethereum.request({ method: 'eth_requestAccounts' });
                provider = new ethers.providers.Web3Provider(window.ethereum);
                signer = provider.getSigner();
                userAddress = await signer.getAddress();

                // Check if on correct network
                const network = await provider.getNetwork();
                if (network.chainId !== CHAIN_ID) {
                    try {
                        await window.ethereum.request({
                            method: 'wallet_switchEthereumChain',
                            params: [{ chainId: '0x' + CHAIN_ID.toString(16) }],
                        });
                    } catch (switchError) {
                        // Network not added, add it
                        if (switchError.code === 4902) {
                            await window.ethereum.request({
                                method: 'wallet_addEthereumChain',
                                params: [{
                                    chainId: '0x' + CHAIN_ID.toString(16),
                                    chainName: 'Lisk Sepolia',
                                    nativeCurrency: {
                                        name: 'Sepolia Ether',
                                        symbol: 'ETH',
                                        decimals: 18
                                    },
                                    rpcUrls: [RPC_URL],
                                    blockExplorerUrls: ['https://sepolia-blockscout.lisk.com']
                                }]
                            });
                        }
                    }
                }

                const balance = await provider.getBalance(userAddress);

                document.getElementById('walletInfo').innerHTML = `
                    <div class="success">
                        <strong>‚úÖ Connected!</strong><br>
                        Address: <span class="address">${userAddress}</span><br>
                        Balance: ${ethers.utils.formatEther(balance)} ETH
                    </div>
                `;

                document.getElementById('createSection').style.display = 'block';
                document.getElementById('connectBtn').disabled = true;
            } catch (error) {
                document.getElementById('walletInfo').innerHTML = `
                    <div class="error">‚ùå ${error.message}</div>
                `;
            }
        }

        async function getSmartAccountAddress() {
            try {
                const salt = document.getElementById('saltInput').value;
                const factory = new ethers.Contract(FACTORY_ADDRESS, FACTORY_ABI, provider);
                const predictedAddress = await factory.getAddress(userAddress, salt);

                // Check if already deployed
                const code = await provider.getCode(predictedAddress);
                const exists = code !== '0x';

                document.getElementById('accountInfo').innerHTML = `
                    <div class="info">
                        <strong>üìç Smart Account Address:</strong><br>
                        <span class="address">${predictedAddress}</span><br><br>
                        Status: ${exists ? '‚úÖ Already deployed' : '‚è≥ Not deployed yet'}
                        ${exists ? `<br><a href="https://sepolia-blockscout.lisk.com/address/${predictedAddress}" target="_blank">View on Explorer</a>` : ''}
                    </div>
                `;

                if (exists) {
                    loadAccountDetails(predictedAddress);
                }
            } catch (error) {
                document.getElementById('accountInfo').innerHTML = `
                    <div class="error">‚ùå ${error.message}</div>
                `;
            }
        }

        async function createSmartAccount() {
            try {
                const salt = document.getElementById('saltInput').value;
                const factory = new ethers.Contract(FACTORY_ADDRESS, FACTORY_ABI, signer);

                document.getElementById('accountInfo').innerHTML = `
                    <div class="info">‚è≥ Creating smart account... Please confirm transaction in MetaMask</div>
                `;

                const tx = await factory.createAccount(userAddress, salt);

                document.getElementById('accountInfo').innerHTML = `
                    <div class="info">‚è≥ Transaction submitted... Waiting for confirmation</div>
                `;

                await tx.wait();

                const accountAddress = await factory.getAddress(userAddress, salt);

                document.getElementById('accountInfo').innerHTML = `
                    <div class="success">
                        <strong>‚úÖ Smart Account Created!</strong><br>
                        Address: <span class="address">${accountAddress}</span><br>
                        <a href="https://sepolia-blockscout.lisk.com/address/${accountAddress}" target="_blank">View on Explorer</a>
                    </div>
                `;

                loadAccountDetails(accountAddress);
            } catch (error) {
                document.getElementById('accountInfo').innerHTML = `
                    <div class="error">‚ùå ${error.message}</div>
                `;
            }
        }

        async function loadAccountDetails(accountAddress) {
            try {
                const account = new ethers.Contract(accountAddress, ACCOUNT_ABI, provider);
                const balance = await provider.getBalance(accountAddress);
                const owner = await account.owner();
                const nonce = await account.getNonce();

                document.getElementById('accountDetails').innerHTML = `
                    <strong>üìä Account Details:</strong><br>
                    Address: <span class="address">${accountAddress}</span><br>
                    Owner: <span class="address">${owner}</span><br>
                    Balance: ${ethers.utils.formatEther(balance)} ETH<br>
                    Nonce: ${nonce.toString()}<br>
                    <a href="https://sepolia-blockscout.lisk.com/address/${accountAddress}" target="_blank">View on Explorer</a>
                `;

                document.getElementById('interactSection').style.display = 'block';

                // Store for later use
                window.smartAccountAddress = accountAddress;
            } catch (error) {
                console.error('Error loading account details:', error);
            }
        }

        async function sendEther() {
            try {
                const recipient = document.getElementById('recipientInput').value;
                const amount = document.getElementById('amountInput').value;

                if (!ethers.utils.isAddress(recipient)) {
                    alert('Invalid recipient address');
                    return;
                }

                if (!amount || parseFloat(amount) <= 0) {
                    alert('Invalid amount');
                    return;
                }

                const account = new ethers.Contract(
                    window.smartAccountAddress,
                    ACCOUNT_ABI,
                    signer
                );

                document.getElementById('txResult').innerHTML = `
                    <div class="info">‚è≥ Sending transaction... Please confirm in MetaMask</div>
                `;

                const tx = await account.execute(
                    recipient,
                    ethers.utils.parseEther(amount),
                    '0x' // empty calldata for ETH transfer
                );

                document.getElementById('txResult').innerHTML = `
                    <div class="info">‚è≥ Transaction submitted... Waiting for confirmation</div>
                `;

                const receipt = await tx.wait();

                document.getElementById('txResult').innerHTML = `
                    <div class="success">
                        <strong>‚úÖ Transaction Successful!</strong><br>
                        Sent ${amount} ETH to ${recipient}<br>
                        <a href="https://sepolia-blockscout.lisk.com/tx/${receipt.transactionHash}" target="_blank">View Transaction</a>
                    </div>
                `;

                // Refresh balance
                loadAccountDetails(window.smartAccountAddress);
            } catch (error) {
                document.getElementById('txResult').innerHTML = `
                    <div class="error">‚ùå ${error.message}</div>
                `;
            }
        }
    </script>
</body>
</html>
